<div class="container">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><%= @video.title %> - å—è¬›çŠ¶æ³åˆ†æ</h1>
        <div>
          <%= link_to "ç®¡ç†è€…è¿½åŠ ", video_management_add_manager_path(video_id: @video), class: "btn btn-outline-primary" %>
          <%= link_to "å‹•ç”»ç·¨é›†", edit_video_path(@video), class: "btn btn-primary" %>
          <%= link_to "æˆ»ã‚‹", root_path, class: "btn btn-secondary" %>
        </div>
      </div>

      <!-- CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h5>
          <p class="text-muted mb-3">åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ï¼ˆå€‹åˆ¥ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ã‹ã‚‰ï¼‰</p>
          <div class="row">
            <div class="col-md-6 mb-2">
              <%= link_to video_management_export_summary_path(video_id: @video, format: :csv), class: "btn btn-success w-100", data: { turbo: false } do %>
                <i class="bi bi-file-earmark-spreadsheet"></i> å…¨ä½“ã‚µãƒãƒªãƒ¼
              <% end %>
              <small class="text-muted d-block mt-1">å‹•ç”»å…¨ä½“ã®çµ±è¨ˆæƒ…å ±</small>
            </div>
            <div class="col-md-6 mb-2">
              <%= link_to video_management_export_questions_path(video_id: @video, format: :csv), class: "btn btn-success w-100", data: { turbo: false } do %>
                <i class="bi bi-file-earmark-spreadsheet"></i> å•é¡Œåˆ¥çµ±è¨ˆ
              <% end %>
              <small class="text-muted d-block mt-1">å„å•é¡Œã®å›ç­”çµ±è¨ˆ</small>
            </div>
          </div>
        </div>
      </div>

      <!-- å…¨ä½“çµ±è¨ˆ -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">ç·å›ç­”æ•°</h5>
              <h2 class="text-primary"><%= @total_responses %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">å—è¬›è€…æ•°</h5>
              <h2 class="text-info"><%= @unique_users %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">æ­£è§£æ•°</h5>
              <h2 class="text-success"><%= @correct_responses %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">æ­£ç­”ç‡</h5>
              <h2 class="text-warning"><%= @accuracy_rate %>%</h2>
            </div>
          </div>
        </div>
      </div>

      <!-- å•é¡Œåˆ¥çµ±è¨ˆ -->
      <div class="card mb-4">
        <div class="card-header">
          <h3>å•é¡Œåˆ¥çµ±è¨ˆ</h3>
        </div>
        <div class="card-body">
          <% if @question_stats.any? %>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>å•é¡Œ</th>
                    <th>ã‚¿ã‚¤ãƒ—</th>
                    <th>æ™‚é–“ä½ç½®</th>
                    <th>å›ç­”æ•°</th>
                    <th>æ­£è§£æ•°</th>
                    <th>æ­£ç­”ç‡</th>
                    <th>å¹³å‡å›ç­”æ™‚é–“</th>
                  </tr>
                </thead>
                <tbody>
                  <% @question_stats.each do |stat| %>
                    <tr>
                      <td><%= truncate(stat[:question].content, length: 50) %></td>
                      <td>
                        <span class="badge <%= question_type_badge_class(stat[:question].question_type) %>">
                          <%= question_type_display(stat[:question].question_type) %>
                        </span>
                      </td>
                      <td><%= format_time_position(stat[:question].time_position) %></td>
                      <td><%= stat[:total_responses] %></td>
                      <td><%= stat[:correct_responses] %></td>
                      <td>
                        <% if stat[:accuracy_rate] >= 80 %>
                          <span class="text-success"><%= stat[:accuracy_rate] %>%</span>
                        <% elsif stat[:accuracy_rate] >= 60 %>
                          <span class="text-warning"><%= stat[:accuracy_rate] %>%</span>
                        <% else %>
                          <span class="text-danger"><%= stat[:accuracy_rate] %>%</span>
                        <% end %>
                      </td>
                      <td><%= stat[:average_response_time] %>ç§’</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted">ã“ã®å‹•ç”»ã«ã¯å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          <% end %>
        </div>
      </div>

      <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã‚°ãƒ©ãƒ• -->
      <% if @learning_sessions.any? %>
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="mb-0">å­¦ç¿’ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³åˆ†æã‚°ãƒ©ãƒ•</h3>
            <small class="text-muted">ğŸ’¡ ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ ã€ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ã€ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒªã‚»ãƒƒãƒˆ</small>
          </div>
          <div class="card-body">
            <!-- ã‚°ãƒ©ãƒ•ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <ul class="nav nav-tabs mb-3" id="chartTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="score-timeline-tab" data-bs-toggle="tab" data-bs-target="#score-timeline" type="button">
                  é›†ä¸­ã‚¹ã‚³ã‚¢æ¨ç§»
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="event-distribution-tab" data-bs-toggle="tab" data-bs-target="#event-distribution" type="button">
                  ã‚¤ãƒ™ãƒ³ãƒˆåˆ†å¸ƒ
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="hourly-activity-tab" data-bs-toggle="tab" data-bs-target="#hourly-activity" type="button">
                  æ™‚é–“å¸¯åˆ¥æ´»å‹•
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="user-scores-tab" data-bs-toggle="tab" data-bs-target="#user-scores" type="button">
                  ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¹ã‚³ã‚¢
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="video-density-tab" data-bs-toggle="tab" data-bs-target="#video-density" type="button">
                  å‹•ç”»ã‚¤ãƒ™ãƒ³ãƒˆå¯†åº¦
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="video-operations-tab" data-bs-toggle="tab" data-bs-target="#video-operations" type="button">
                  å‹•ç”»æ“ä½œãƒãƒƒãƒ—
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="user-operations-tab" data-bs-toggle="tab" data-bs-target="#user-operations" type="button">
                  ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥æ“ä½œ
                </button>
              </li>
            </ul>

            <!-- ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="tab-content" id="chartTabsContent">
              <!-- 1. é›†ä¸­ã‚¹ã‚³ã‚¢æ¨ç§»ã‚°ãƒ©ãƒ• -->
              <div class="tab-pane fade show active" id="score-timeline" role="tabpanel">
                <div class="chart-container" style="position: relative; height: 400px;">
                  <canvas id="scoreTimelineChart"></canvas>
                </div>
                <p class="text-muted mt-2 text-center">
                  <small>å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é›†ä¸­ã‚¹ã‚³ã‚¢ã®æ™‚é–“çš„æ¨ç§»ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³çµŒéæ™‚é–“ï¼ˆç§’ï¼‰ã«å¯¾ã™ã‚‹ã‚¹ã‚³ã‚¢ã®å¤‰åŒ–ã‚’ç¢ºèªã§ãã¾ã™ã€‚</small>
                </p>
              </div>

              <!-- 2. ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—åˆ†å¸ƒã‚°ãƒ©ãƒ• -->
              <div class="tab-pane fade" id="event-distribution" role="tabpanel">
                <div class="row">
                  <div class="col-md-6 offset-md-3">
                    <div class="chart-container" style="position: relative; height: 400px;">
                      <canvas id="eventDistributionChart"></canvas>
                    </div>
                  </div>
                </div>
                <p class="text-muted mt-2 text-center">
                  <small>å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§è¨˜éŒ²ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã®ã‚«ãƒ†ã‚´ãƒªåˆ¥åˆ†å¸ƒã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</small>
                </p>
              </div>

              <!-- 3. æ™‚é–“å¸¯åˆ¥æ´»å‹•é‡ã‚°ãƒ©ãƒ• -->
              <div class="tab-pane fade" id="hourly-activity" role="tabpanel">
                <div class="chart-container" style="position: relative; height: 400px;">
                  <canvas id="hourlyActivityChart"></canvas>
                </div>
                <p class="text-muted mt-2 text-center">
                  <small>1æ—¥ã®ä¸­ã§ã©ã®æ™‚é–“å¸¯ã«å­¦ç¿’æ´»å‹•ãŒæ´»ç™ºã‹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</small>
                </p>
              </div>

              <!-- 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥å¹³å‡ã‚¹ã‚³ã‚¢ã‚°ãƒ©ãƒ• -->
              <div class="tab-pane fade" id="user-scores" role="tabpanel">
                <div class="chart-container" style="position: relative; height: 400px;">
                  <canvas id="userScoresChart"></canvas>
                </div>
                <p class="text-muted mt-2 text-center">
                  <small>å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¹³å‡é›†ä¸­ã‚¹ã‚³ã‚¢ã‚’æ¯”è¼ƒè¡¨ç¤ºã—ã¾ã™ã€‚</small>
                </p>
              </div>

              <!-- 5. å‹•ç”»æ™‚é–“åˆ¥ã‚¤ãƒ™ãƒ³ãƒˆå¯†åº¦ã‚°ãƒ©ãƒ• -->
              <div class="tab-pane fade" id="video-density" role="tabpanel">
                <div class="chart-container" style="position: relative; height: 400px;">
                  <canvas id="videoDensityChart"></canvas>
                </div>
                <p class="text-muted mt-2 text-center">
                  <small>å‹•ç”»ã®ã©ã®éƒ¨åˆ†ã§å­¦ç¿’æ´»å‹•ãŒæ´»ç™ºã‹ã‚’30ç§’å˜ä½ã§è¡¨ç¤ºã—ã¾ã™ã€‚</small>
                </p>
              </div>

              <!-- 6. å‹•ç”»æ“ä½œãƒãƒƒãƒ—ï¼ˆå…¨ä½“ï¼‰ -->
              <div class="tab-pane fade" id="video-operations" role="tabpanel">
                <div class="chart-container" style="position: relative; height: 400px;">
                  <canvas id="videoOperationsChart"></canvas>
                </div>
                <p class="text-muted mt-2 text-center">
                  <small>å‹•ç”»å†…ã®ã©ã®æ™‚é–“ã§ä¸€æ™‚åœæ­¢ã‚„ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚·ãƒ¼ã‚¯ï¼‰ãŒè¡Œã‚ã‚ŒãŸã‹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚æ£’ãŒé«˜ã„ã»ã©æ“ä½œãŒå¤šã„ç®‡æ‰€ã§ã™ã€‚</small>
                </p>
              </div>

              <!-- 7. ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥å‹•ç”»æ“ä½œ -->
              <div class="tab-pane fade" id="user-operations" role="tabpanel">
                <div class="chart-container" style="position: relative; height: 400px;">
                  <canvas id="userOperationsChart"></canvas>
                </div>
                <p class="text-muted mt-2 text-center">
                  <small>å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‹•ç”»ã®ã©ã®æ™‚é–“ã§æ“ä½œã‚’è¡Œã£ãŸã‹ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¥ã«è¡¨ç¤ºã—ã¾ã™ã€‚</small>
                </p>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆ -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">ç·å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³</h5>
              <h2 class="text-primary"><%= @total_sessions %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">å®Œäº†ã‚»ãƒƒã‚·ãƒ§ãƒ³</h5>
              <h2 class="text-success"><%= @completed_sessions %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">å¹³å‡å­¦ç¿’æ™‚é–“</h5>
              <h2 class="text-info">
                <% if @average_session_duration && @average_session_duration > 0 %>
                  <%= (@average_session_duration / 60).round(1) %>åˆ†
                <% else %>
                  -
                <% end %>
              </h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">å¹³å‡æœ€çµ‚ã‚¹ã‚³ã‚¢</h5>
              <h2 class="text-warning">
                <% if @average_final_score %>
                  <%= @average_final_score.round(1) %>ç‚¹
                <% else %>
                  -
                <% end %>
              </h2>
            </div>
          </div>
        </div>
      </div>

      <!-- å‹•ç”»æ“ä½œçµ±è¨ˆï¼ˆ1åˆ†ä»¥ä¸Šã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å¹³å‡ï¼‰ -->
      <div class="card mb-4">
        <div class="card-header">
          <h3>å‹•ç”»æ“ä½œçµ±è¨ˆ <small class="text-muted">(1åˆ†ä»¥ä¸Šã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å¹³å‡)</small></h3>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 class="card-title">â¸ï¸ ä¸€æ™‚åœæ­¢</h5>
                  <h2 class="text-warning"><%= @avg_pause_count %></h2>
                  <p class="text-muted">å›/ã‚»ãƒƒã‚·ãƒ§ãƒ³</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 class="card-title">â© å‰é€²ã‚¹ã‚­ãƒƒãƒ—</h5>
                  <h2 class="text-primary"><%= @avg_forward_seek_count %></h2>
                  <p class="text-muted">å›/ã‚»ãƒƒã‚·ãƒ§ãƒ³</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 class="card-title">âª å¾Œé€€ã‚¹ã‚­ãƒƒãƒ—</h5>
                  <h2 class="text-info"><%= @avg_backward_seek_count %></h2>
                  <p class="text-muted">å›/ã‚»ãƒƒã‚·ãƒ§ãƒ³</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 class="card-title">âš¡ å†ç”Ÿé€Ÿåº¦å¤‰æ›´</h5>
                  <h2 class="text-success"><%= @avg_playback_rate_change_count %></h2>
                  <p class="text-muted">å›/ã‚»ãƒƒã‚·ãƒ§ãƒ³</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ -->
      <div class="card mb-4">
        <div class="card-header">
          <h3>å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´</h3>
        </div>
        <div class="card-body">
          <% if @learning_sessions.any? %>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>å—è¬›è€…</th>
                    <th>é–‹å§‹æ™‚åˆ»</th>
                    <th>çµ‚äº†æ™‚åˆ»</th>
                    <th>å­¦ç¿’æ™‚é–“</th>
                    <th>æœ€çµ‚ã‚¹ã‚³ã‚¢</th>
                    <th>ã‚¤ãƒ™ãƒ³ãƒˆæ•°</th>
                    <th title="ä¸€æ™‚åœæ­¢å›æ•°">â¸ï¸</th>
                    <th title="å‰é€²ã‚¹ã‚­ãƒƒãƒ—å›æ•°">â©</th>
                    <th title="å¾Œé€€ã‚¹ã‚­ãƒƒãƒ—å›æ•°">âª</th>
                    <th title="å†ç”Ÿé€Ÿåº¦å¤‰æ›´å›æ•°">âš¡</th>
                    <th>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</th>
                    <th>è©³ç´°</th>
                  </tr>
                </thead>
                <tbody>
                  <% @learning_sessions.each do |session| %>
                    <% operation_stats = session.video_operation_stats %>
                    <tr>
                      <td>
                        <%= session.user.name %>
                        <br><small class="text-muted"><%= session.user.email %></small>
                      </td>
                      <td><%= session.session_start_time.strftime("%Y/%m/%d %H:%M") %></td>
                      <td>
                        <% if session.session_end_time %>
                          <%= session.session_end_time.strftime("%Y/%m/%d %H:%M") %>
                        <% else %>
                          <span class="text-warning">é€²è¡Œä¸­</span>
                        <% end %>
                      </td>
                      <td><%= session.format_duration %></td>
                      <td>
                        <% if session.final_score %>
                          <span class="badge <%= session.final_score >= 70 ? 'bg-success' : session.final_score >= 50 ? 'bg-warning' : 'bg-danger' %>">
                            <%= session.final_score.round(1) %>ç‚¹
                          </span>
                        <% else %>
                          -
                        <% end %>
                      </td>
                      <td><%= session.total_events || session.timestamp_events.count %></td>
                      <td class="text-center"><%= operation_stats[:pause_count] %></td>
                      <td class="text-center"><%= operation_stats[:forward_seek_count] %></td>
                      <td class="text-center"><%= operation_stats[:backward_seek_count] %></td>
                      <td class="text-center"><%= operation_stats[:playback_rate_change_count] %></td>
                      <td>
                        <div class="btn-group-vertical btn-group-sm">
                          <%= link_to "ğŸ“Š", video_management_export_session_detail_path(video_id: @video, session_id: session.id, format: :csv), 
                              class: "btn btn-sm btn-outline-success", 
                              title: "ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°CSV",
                              data: { turbo: false } %>
                          <%= link_to "ğŸ“", video_management_export_session_events_path(video_id: @video, session_id: session.id, format: :csv), 
                              class: "btn btn-sm btn-outline-success", 
                              title: "ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³CSV",
                              data: { turbo: false } %>
                        </div>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-primary" onclick="showSessionDetail(<%= session.id %>)">
                          ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º
                        </button>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted">ã¾ã å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          <% end %>
        </div>
      </div>

      <!-- è©³ç´°ãªå›ç­”å±¥æ­´ -->
      <div class="card">
        <div class="card-header">
          <h3>å›ç­”å±¥æ­´</h3>
        </div>
        <div class="card-body">
          <% if @user_responses.any? %>
            <div class="table-responsive">
              <table class="table table-striped table-sm">
                <thead>
                  <tr>
                    <th>å—è¬›è€…</th>
                    <th>å•é¡Œ</th>
                    <th>å›ç­”</th>
                    <th>æ­£èª¤</th>
                    <th>å›ç­”æ™‚é–“</th>
                    <th>å›ç­”æ—¥æ™‚</th>
                  </tr>
                </thead>
                <tbody>
                  <% @user_responses.each do |response| %>
                    <tr>
                      <td>
                        <% if response.user %>
                          <%= response.user.name %>
                          <br><small class="text-muted"><%= response.user.email %></small>
                        <% else %>
                          <em>ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼</em>
                        <% end %>
                      </td>
                      <td><%= truncate(response.question.content, length: 40) %></td>
                      <td><%= truncate(response.user_answer, length: 30) %></td>
                      <td>
                        <% if response.is_correct %>
                          <span class="badge bg-success">æ­£è§£</span>
                        <% else %>
                          <span class="badge bg-danger">ä¸æ­£è§£</span>
                        <% end %>
                      </td>
                      <td>
                        <% if response.response_time %>
                          <%= (response.response_time / 1000.0).round(1) %>ç§’
                        <% else %>
                          -
                        <% end %>
                      </td>
                      <td><%= response.created_at.strftime("%Y/%m/%d %H:%M") %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted">ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="sessionDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title">å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h5>
          <small class="text-muted">ğŸ’¡ ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ ã€ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ã€ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒªã‚»ãƒƒãƒˆ</small>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
        <div id="chartContainer" style="position: relative; height: 400px; margin-bottom: 20px;">
          <canvas id="timelineChart"></canvas>
        </div>
        
        <!-- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ­ã‚° -->
        <div class="mt-4">
          <h6>è©³ç´°ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°</h6>
          <div id="timestampLog" style="max-height: 300px; overflow-y: auto;">
            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<style>
  .timestamp-entry {
    padding: 8px;
    margin-bottom: 4px;
    border-left: 3px solid #007bff;
    background-color: #f8f9fa;
    border-radius: 4px;
  }
  
  .timestamp-entry.score-event {
    border-left-color: #28a745;
  }
  
  .timestamp-entry.video-event {
    border-left-color: #ffc107;
  }
  
  .timestamp-entry.interaction-event {
    border-left-color: #17a2b8;
  }
  
  .timestamp-header {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    margin-bottom: 4px;
  }
  
  .timestamp-description {
    font-size: 0.9em;
    color: #6c757d;
  }
</style>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—æ±šæŸ“ã‚’é¿ã‘ã‚‹ãŸã‚ã®å³æ™‚å®Ÿè¡Œé–¢æ•°
(function() {
  'use strict';
  
  let sessionDetailChart = null;

  window.showSessionDetail = function(sessionId) {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modalElement = document.getElementById('sessionDetailModal');
    const modal = new bootstrap.Modal(modalElement);
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå®Œå…¨ã«è¡¨ç¤ºã•ã‚ŒãŸå¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    modalElement.addEventListener('shown.bs.modal', function onShown() {
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä¸€åº¦ã ã‘å®Ÿè¡Œ
      modalElement.removeEventListener('shown.bs.modal', onShown);
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const url = '<%= video_management_session_detail_path(video_id: @video, session_id: 'PLACEHOLDER') %>'.replace('PLACEHOLDER', sessionId);
      console.log('Fetching session data from:', url);
      
      fetch(url, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        }
      })
      .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿:', data);
        renderChart(data);
        renderTimestampLog(data);
      })
      .catch(error => {
        console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      });
    });
    
    modal.show();
  };

  function renderChart(data) {
    const ctx = document.getElementById('timelineChart');
    if (!ctx) {
      console.error('timelineChart canvas ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    console.log('ã‚°ãƒ©ãƒ•æç”»é–‹å§‹:', data);
    
    // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆ
    if (!data.timeline || data.timeline.length === 0) {
      console.warn('ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
      ctx.parentElement.innerHTML = '<p class="text-muted text-center">ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã¯ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
      return;
    }
    
    // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’å‰Šé™¤
    if (sessionDetailChart) {
      sessionDetailChart.destroy();
    }
    
    try {
      // é›†ä¸­åº¦ã‚¹ã‚³ã‚¢ã§è‰²ã‚’æ±ºå®šã™ã‚‹é–¢æ•°
      const getColorByScore = (score) => {
        if (score <= 25) return '#dc3545'; // èµ¤
        if (score <= 50) return '#fd7e14'; // ã‚ªãƒ¬ãƒ³ã‚¸
        if (score <= 75) return '#ffc107'; // é»„è‰²
        return '#28a745'; // ç·‘
      };
      
      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æ™‚ç³»åˆ—é †ã«ä¸¦ã¹ã€å„ç‚¹ã«è‰²æƒ…å ±ã‚’è¿½åŠ 
      const timelineData = data.timeline.map(e => ({
        x: e.x,
        y: e.video_time || 0,
        score: e.y,
        description: e.description,
        color: getColorByScore(e.y)
      }));
      
      const datasets = [
        {
          label: 'è¦–è´ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³',
          data: timelineData,
          borderColor: '#6c757d',
          borderWidth: 2,
          showLine: true,
          tension: 0,
          pointRadius: 4,
          pointHoverRadius: 7,
          pointBackgroundColor: timelineData.map(d => d.color),
          pointBorderColor: timelineData.map(d => d.color)
        },
        // å‡¡ä¾‹ç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
        { label: 'é›†ä¸­åº¦: 0-25 (ä½)', data: [], borderColor: '#dc3545', backgroundColor: '#dc3545', pointRadius: 5 },
        { label: 'é›†ä¸­åº¦: 26-50', data: [], borderColor: '#fd7e14', backgroundColor: '#fd7e14', pointRadius: 5 },
        { label: 'é›†ä¸­åº¦: 51-75', data: [], borderColor: '#ffc107', backgroundColor: '#ffc107', pointRadius: 5 },
        { label: 'é›†ä¸­åº¦: 76-100 (é«˜)', data: [], borderColor: '#28a745', backgroundColor: '#28a745', pointRadius: 5 }
      ];
      
      sessionDetailChart = new Chart(ctx, {
      type: 'scatter',
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'linear',
            title: {
              display: true,
              text: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³çµŒéæ™‚é–“ï¼ˆç§’ï¼‰'
            },
            ticks: {
              callback: function(value) {
                const minutes = Math.floor(value / 60);
                const seconds = Math.floor(value % 60);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
              }
            }
          },
          y: {
            type: 'linear',
            title: {
              display: true,
              text: 'å‹•ç”»å†ç”Ÿæ™‚é–“ï¼ˆç§’ï¼‰'
            },
            ticks: {
              callback: function(value) {
                const minutes = Math.floor(value / 60);
                const seconds = Math.floor(value % 60);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
              }
            },
            beginAtZero: true
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top'
          },
          zoom: {
            zoom: {
              wheel: {
                enabled: true,
              },
              pinch: {
                enabled: true
              },
              mode: 'xy',
            },
            pan: {
              enabled: true,
              mode: 'xy',
            },
            limits: {
              y: {min: 0, max: 100}
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const rawData = context.raw;
                const videoMinutes = Math.floor(context.parsed.y / 60);
                const videoSeconds = Math.floor(context.parsed.y % 60);
                return `é›†ä¸­åº¦: ${rawData.score.toFixed(1)}ç‚¹ | å‹•ç”»: ${videoMinutes}:${videoSeconds.toString().padStart(2, '0')}`;
              },
              title: function(context) {
                const minutes = Math.floor(context[0].parsed.x / 60);
                const seconds = Math.floor(context[0].parsed.x % 60);
                return `çµŒéæ™‚é–“: ${minutes}:${seconds.toString().padStart(2, '0')}`;
              }
            }
          }
        }
      }
    });
    
    console.log('ã‚°ãƒ©ãƒ•ä½œæˆå®Œäº†:', sessionDetailChart);
    
    // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    ctx.ondblclick = function() {
      sessionDetailChart.resetZoom();
    };
    } catch (error) {
      console.error('ã‚°ãƒ©ãƒ•ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
      ctx.parentElement.innerHTML = '<p class="text-danger text-center">ã‚°ãƒ©ãƒ•ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '</p>';
    }
  }

  function renderTimestampLog(data) {
    const logContainer = document.getElementById('timestampLog');
    
    // å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—é †ã«çµåˆ
    const allEvents = [
      ...data.timeline.map(e => ({...e, category: 'timeline'})),
      ...data.score_changes.map(e => ({...e, category: 'score'})),
      ...data.video_operations.map(e => ({...e, category: 'video'})),
      ...data.interactions.map(e => ({...e, category: 'interaction'}))
    ].sort((a, b) => (a.time || a.x) - (b.time || b.x));
    
    logContainer.innerHTML = allEvents.map(event => {
      const time = event.time || event.x;
      const category = event.category;
      
      return `
        <div class="timestamp-entry ${category}-event">
          <div class="timestamp-header">
            <span>${formatTime(time)}</span>
            <span class="badge bg-secondary">${category}</span>
          </div>
          <div class="timestamp-description">
            ${event.description || event.reason || event.operation || event.type}
          </div>
        </div>
      `;
    }).join('');
  }

  function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
  }
})();

// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³åˆ†æã‚°ãƒ©ãƒ•ã®åˆæœŸåŒ–
<% if @learning_sessions.any? %>
// Turboå¯¾å¿œ: DOMContentLoadedã¨turbo:loadã®ä¸¡æ–¹ã«å¯¾å¿œ
// ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let chartInstances = {};

function initializeAnalyticsCharts() {
  // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
  Object.keys(chartInstances).forEach(key => {
    if (chartInstances[key]) {
      chartInstances[key].destroy();
      chartInstances[key] = null;
    }
  });
  
  // å…±é€šã®Chart.jsã‚ªãƒ—ã‚·ãƒ§ãƒ³
  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        display: true,
        position: 'top'
      }
    }
  };

  // 1. é›†ä¸­ã‚¹ã‚³ã‚¢æ¨ç§»ã‚°ãƒ©ãƒ•
  const scoreTimelineCtx = document.getElementById('scoreTimelineChart');
  if (scoreTimelineCtx) {
    const scoreTimelineData = <%= raw @score_timeline_data.to_json %>;
    
    // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
    const colors = [
      'rgba(255, 99, 132, 1)',
      'rgba(54, 162, 235, 1)',
      'rgba(255, 206, 86, 1)',
      'rgba(75, 192, 192, 1)',
      'rgba(153, 102, 255, 1)',
      'rgba(255, 159, 64, 1)',
      'rgba(199, 199, 199, 1)',
      'rgba(83, 102, 255, 1)'
    ];

    // é›†ä¸­åº¦ã‚¹ã‚³ã‚¢ã§è‰²ã‚’æ±ºå®šã™ã‚‹é–¢æ•°
    const getColorByScore = (score) => {
      if (score <= 25) return '#dc3545'; // èµ¤
      if (score <= 50) return '#fd7e14'; // ã‚ªãƒ¬ãƒ³ã‚¸
      if (score <= 75) return '#ffc107'; // é»„è‰²
      return '#28a745'; // ç·‘
    };

    chartInstances.scoreTimeline = new Chart(scoreTimelineCtx, {
      type: 'scatter',
      data: {
        datasets: scoreTimelineData.map((session, index) => {
          // å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã«è‰²æƒ…å ±ã‚’è¿½åŠ 
          const sessionData = session.data.map(point => ({
            x: point.x,
            y: point.video_time || 0,
            score: point.y,
            video_time: point.video_time,
            color: getColorByScore(point.y)
          }));
          
          return {
            label: session.label,
            data: sessionData,
            borderColor: colors[index % colors.length],
            borderWidth: 2,
            showLine: true,
            tension: 0,
            pointRadius: 4,
            pointHoverRadius: 7,
            pointBackgroundColor: sessionData.map(d => d.color),
            pointBorderColor: sessionData.map(d => d.color)
          };
        })
      },
      options: {
        ...commonOptions,
        scales: {
          x: {
            type: 'linear',
            title: {
              display: true,
              text: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³çµŒéæ™‚é–“ï¼ˆç§’ï¼‰'
            },
            ticks: {
              callback: function(value) {
                const minutes = Math.floor(value / 60);
                const seconds = Math.floor(value % 60);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
              }
            }
          },
          y: {
            type: 'linear',
            title: {
              display: true,
              text: 'å‹•ç”»å†ç”Ÿæ™‚é–“ï¼ˆç§’ï¼‰'
            },
            ticks: {
              callback: function(value) {
                const minutes = Math.floor(value / 60);
                const seconds = Math.floor(value % 60);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
              }
            },
            beginAtZero: true
          }
        },
        plugins: {
          ...commonOptions.plugins,
          zoom: {
            zoom: {
              wheel: {
                enabled: true,
              },
              pinch: {
                enabled: true
              },
              mode: 'xy',
            },
            pan: {
              enabled: true,
              mode: 'xy',
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const point = context.raw;
                const score = point.score !== undefined ? point.score : 0;
                const videoMinutes = Math.floor(context.parsed.y / 60);
                const videoSeconds = Math.floor(context.parsed.y % 60);
                
                return `${context.dataset.label} - é›†ä¸­åº¦: ${score.toFixed(1)}ç‚¹ | å‹•ç”»: ${videoMinutes}:${videoSeconds.toString().padStart(2, '0')}`;
              },
              title: function(context) {
                const minutes = Math.floor(context[0].parsed.x / 60);
                const seconds = Math.floor(context[0].parsed.x % 60);
                return `çµŒéæ™‚é–“: ${minutes}:${seconds.toString().padStart(2, '0')}`;
              }
            }
          }
        }
      }
    });
    
    // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    scoreTimelineCtx.ondblclick = function() {
      chartInstances.scoreTimeline.resetZoom();
    };
  }

  // 2. ã‚¤ãƒ™ãƒ³ãƒˆåˆ†å¸ƒã‚°ãƒ©ãƒ•ï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰
  const eventDistCtx = document.getElementById('eventDistributionChart');
  if (eventDistCtx) {
    const eventData = <%= raw @event_distribution_data.to_json %>;
    
    chartInstances.eventDistribution = new Chart(eventDistCtx, {
      type: 'doughnut',
      data: {
        labels: eventData.labels,
        datasets: [{
          data: eventData.values,
          backgroundColor: Object.values(eventData.colors),
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        ...commonOptions,
        plugins: {
          ...commonOptions.plugins,
          legend: {
            position: 'right'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((context.parsed / total) * 100).toFixed(1);
                return context.label + ': ' + context.parsed + 'ä»¶ (' + percentage + '%)';
              }
            }
          }
        }
      }
    });
  }

  // 3. æ™‚é–“å¸¯åˆ¥æ´»å‹•é‡ã‚°ãƒ©ãƒ•
  const hourlyCtx = document.getElementById('hourlyActivityChart');
  if (hourlyCtx) {
    const hourlyData = <%= raw @hourly_activity_data.to_json %>;
    
    chartInstances.hourlyActivity = new Chart(hourlyCtx, {
      type: 'bar',
      data: {
        labels: hourlyData.labels.map(h => h + 'æ™‚'),
        datasets: [{
          label: 'ã‚¤ãƒ™ãƒ³ãƒˆæ•°',
          data: hourlyData.values,
          backgroundColor: 'rgba(54, 162, 235, 0.8)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          x: {
            title: {
              display: true,
              text: 'æ™‚é–“å¸¯'
            }
          },
          y: {
            title: {
              display: true,
              text: 'ã‚¤ãƒ™ãƒ³ãƒˆæ•°'
            },
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        },
        plugins: {
          ...commonOptions.plugins,
          zoom: {
            zoom: {
              wheel: {
                enabled: true,
              },
              pinch: {
                enabled: true
              },
              mode: 'xy',
            },
            pan: {
              enabled: true,
              mode: 'xy',
            }
          }
        }
      }
    });
    
    // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    hourlyCtx.ondblclick = function() {
      chartInstances.hourlyActivity.resetZoom();
    };
  }

  // 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥å¹³å‡ã‚¹ã‚³ã‚¢ã‚°ãƒ©ãƒ•
  const userScoresCtx = document.getElementById('userScoresChart');
  if (userScoresCtx) {
    const userData = <%= raw @user_score_data.to_json %>;
    
    chartInstances.userScores = new Chart(userScoresCtx, {
      type: 'bar',
      data: {
        labels: userData.labels,
        datasets: [{
          label: 'å¹³å‡ã‚¹ã‚³ã‚¢',
          data: userData.values,
          backgroundColor: userData.values.map(score => {
            if (score >= 70) return 'rgba(40, 167, 69, 0.8)';
            if (score >= 50) return 'rgba(255, 193, 7, 0.8)';
            return 'rgba(220, 53, 69, 0.8)';
          }),
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        ...commonOptions,
        scales: {
          x: {
            title: {
              display: true,
              text: 'å¹³å‡é›†ä¸­ã‚¹ã‚³ã‚¢'
            },
            beginAtZero: true,
            max: 100
          },
          y: {
            title: {
              display: true,
              text: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'
            }
          }
        },
        plugins: {
          ...commonOptions.plugins,
          tooltip: {
            callbacks: {
              label: function(context) {
                const index = context.dataIndex;
                const score = context.parsed.x.toFixed(1);
                const sessions = userData.counts[index];
                return [
                  'å¹³å‡ã‚¹ã‚³ã‚¢: ' + score + 'ç‚¹',
                  'ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: ' + sessions + 'å›'
                ];
              }
            }
          }
        }
      }
    });
  }

  // 5. å‹•ç”»æ™‚é–“åˆ¥ã‚¤ãƒ™ãƒ³ãƒˆå¯†åº¦ã‚°ãƒ©ãƒ•
  const videoDensityCtx = document.getElementById('videoDensityChart');
  if (videoDensityCtx) {
    const densityData = <%= raw @video_time_density_data.to_json %>;
    
    chartInstances.videoDensity = new Chart(videoDensityCtx, {
      type: 'bar',
      data: {
        labels: densityData.map(d => d.label),
        datasets: [{
          label: 'ã‚¤ãƒ™ãƒ³ãƒˆæ•°',
          data: densityData.map(d => d.y),
          backgroundColor: 'rgba(255, 99, 132, 0.8)',
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 1
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          x: {
            title: {
              display: true,
              text: 'å‹•ç”»æ™‚é–“ï¼ˆ30ç§’å˜ä½ï¼‰'
            }
          },
          y: {
            title: {
              display: true,
              text: 'ã‚¤ãƒ™ãƒ³ãƒˆæ•°'
            },
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        },
        plugins: {
          ...commonOptions.plugins,
          zoom: {
            zoom: {
              wheel: {
                enabled: true,
              },
              pinch: {
                enabled: true
              },
              mode: 'xy',
            },
            pan: {
              enabled: true,
              mode: 'xy',
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'ã‚¤ãƒ™ãƒ³ãƒˆæ•°: ' + context.parsed.y + 'ä»¶';
              }
            }
          }
        }
      }
    });
    
    // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    videoDensityCtx.ondblclick = function() {
      chartInstances.videoDensity.resetZoom();
    };
  }

  // 6. å‹•ç”»æ“ä½œãƒãƒƒãƒ—ï¼ˆå…¨ä½“ï¼‰
  const videoOperationsCtx = document.getElementById('videoOperationsChart');
  if (videoOperationsCtx) {
    const operationsData = <%= raw @video_operations_map_data.to_json %>;
    
    chartInstances.videoOperations = new Chart(videoOperationsCtx, {
      type: 'bar',
      data: {
        labels: operationsData.map(d => d.label),
        datasets: [
          {
            label: 'ä¸€æ™‚åœæ­¢',
            data: operationsData.map(d => d.pause),
            backgroundColor: 'rgba(255, 193, 7, 0.8)',
            borderColor: 'rgba(255, 193, 7, 1)',
            borderWidth: 1
          },
          {
            label: 'ã‚¹ã‚­ãƒƒãƒ—/ã‚·ãƒ¼ã‚¯',
            data: operationsData.map(d => d.seek),
            backgroundColor: 'rgba(220, 53, 69, 0.8)',
            borderColor: 'rgba(220, 53, 69, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        ...commonOptions,
        scales: {
          x: {
            title: {
              display: true,
              text: 'å‹•ç”»æ™‚é–“'
            },
            ticks: {
              maxRotation: 45,
              minRotation: 45
            }
          },
          y: {
            title: {
              display: true,
              text: 'æ“ä½œå›æ•°'
            },
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        },
        plugins: {
          ...commonOptions.plugins,
          zoom: {
            zoom: {
              wheel: {
                enabled: true,
              },
              pinch: {
                enabled: true
              },
              mode: 'xy',
            },
            pan: {
              enabled: true,
              mode: 'xy',
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y + 'å›';
              },
              footer: function(context) {
                const index = context[0].dataIndex;
                const total = operationsData[index].total;
                return 'åˆè¨ˆ: ' + total + 'å›';
              }
            }
          }
        }
      }
    });
    
    videoOperationsCtx.ondblclick = function() {
      chartInstances.videoOperations.resetZoom();
    };
  }

  // 7. ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥å‹•ç”»æ“ä½œ
  const userOperationsCtx = document.getElementById('userOperationsChart');
  if (userOperationsCtx) {
    const userOpsData = <%= raw @user_operations_map_data.to_json %>;
    
    const colors = [
      'rgba(255, 99, 132, 0.6)',
      'rgba(54, 162, 235, 0.6)',
      'rgba(255, 206, 86, 0.6)',
      'rgba(75, 192, 192, 0.6)',
      'rgba(153, 102, 255, 0.6)',
      'rgba(255, 159, 64, 0.6)',
      'rgba(199, 199, 199, 0.6)',
      'rgba(83, 102, 255, 0.6)'
    ];
    
    chartInstances.userOperations = new Chart(userOperationsCtx, {
      type: 'scatter',
      data: {
        datasets: userOpsData.map((session, index) => ({
          label: session.label,
          data: session.data,
          backgroundColor: colors[index % colors.length],
          borderColor: colors[index % colors.length].replace('0.6', '1'),
          pointRadius: function(context) {
            const point = context.raw;
            return 3 + (point.y * 2); // æ“ä½œå›æ•°ã«å¿œã˜ã¦ãƒã‚¤ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¤‰æ›´
          },
          pointHoverRadius: function(context) {
            const point = context.raw;
            return 5 + (point.y * 2);
          }
        }))
      },
      options: {
        ...commonOptions,
        scales: {
          x: {
            type: 'linear',
            title: {
              display: true,
              text: 'å‹•ç”»æ™‚é–“ï¼ˆç§’ï¼‰'
            },
            ticks: {
              callback: function(value) {
                const minutes = Math.floor(value / 60);
                const seconds = value % 60;
                return minutes + ':' + seconds.toString().padStart(2, '0');
              }
            }
          },
          y: {
            title: {
              display: true,
              text: 'æ“ä½œå›æ•°'
            },
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        },
        plugins: {
          ...commonOptions.plugins,
          zoom: {
            zoom: {
              wheel: {
                enabled: true,
              },
              pinch: {
                enabled: true
              },
              mode: 'xy',
            },
            pan: {
              enabled: true,
              mode: 'xy',
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const point = context.raw;
                const minutes = Math.floor(point.x / 60);
                const seconds = Math.floor(point.x % 60);
                return [
                  context.dataset.label,
                  `å‹•ç”»æ™‚é–“: ${minutes}:${seconds.toString().padStart(2, '0')}`,
                  `æ“ä½œå›æ•°: ${point.y}å›`,
                  `  ä¸€æ™‚åœæ­¢: ${point.pause}å›`,
                  `  ã‚¹ã‚­ãƒƒãƒ—: ${point.seek}å›`
                ];
              }
            }
          }
        }
      }
    });
    
    userOperationsCtx.ondblclick = function() {
      chartInstances.userOperations.resetZoom();
    };
  }
}

// åˆå›èª­ã¿è¾¼ã¿ã¨Turboé·ç§»ã®ä¸¡æ–¹ã§å®Ÿè¡Œ
document.addEventListener('DOMContentLoaded', initializeAnalyticsCharts);
document.addEventListener('turbo:load', initializeAnalyticsCharts);

// Turboé·ç§»å‰ã«ãƒãƒ£ãƒ¼ãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
document.addEventListener('turbo:before-render', function() {
  // ä¿æŒã—ã¦ã„ã‚‹ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„
  Object.keys(chartInstances).forEach(key => {
    if (chartInstances[key]) {
      chartInstances[key].destroy();
      chartInstances[key] = null;
    }
  });
});
<% end %>
</script>
