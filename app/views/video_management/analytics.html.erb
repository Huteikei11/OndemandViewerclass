<div class="container">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><%= @video.title %> - 受講状況分析</h1>
        <div>
          <%= link_to "タイムライン", video_management_timeline_path(video_id: @video), class: "btn btn-info" %>
          <%= link_to "管理者追加", video_management_add_manager_path(video_id: @video), class: "btn btn-outline-primary" %>
          <%= link_to "動画編集", edit_video_path(@video), class: "btn btn-primary" %>
          <%= link_to "戻る", root_path, class: "btn btn-secondary" %>
        </div>
      </div>

      <!-- 全体統計 -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">総回答数</h5>
              <h2 class="text-primary"><%= @total_responses %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">受講者数</h5>
              <h2 class="text-info"><%= @unique_users %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">正解数</h5>
              <h2 class="text-success"><%= @correct_responses %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">正答率</h5>
              <h2 class="text-warning"><%= @accuracy_rate %>%</h2>
            </div>
          </div>
        </div>
      </div>

      <!-- 問題別統計 -->
      <div class="card mb-4">
        <div class="card-header">
          <h3>問題別統計</h3>
        </div>
        <div class="card-body">
          <% if @question_stats.any? %>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>問題</th>
                    <th>タイプ</th>
                    <th>時間位置</th>
                    <th>回答数</th>
                    <th>正解数</th>
                    <th>正答率</th>
                    <th>平均回答時間</th>
                  </tr>
                </thead>
                <tbody>
                  <% @question_stats.each do |stat| %>
                    <tr>
                      <td><%= truncate(stat[:question].content, length: 50) %></td>
                      <td>
                        <span class="badge <%= question_type_badge_class(stat[:question].question_type) %>">
                          <%= question_type_display(stat[:question].question_type) %>
                        </span>
                      </td>
                      <td><%= format_time_position(stat[:question].time_position) %></td>
                      <td><%= stat[:total_responses] %></td>
                      <td><%= stat[:correct_responses] %></td>
                      <td>
                        <% if stat[:accuracy_rate] >= 80 %>
                          <span class="text-success"><%= stat[:accuracy_rate] %>%</span>
                        <% elsif stat[:accuracy_rate] >= 60 %>
                          <span class="text-warning"><%= stat[:accuracy_rate] %>%</span>
                        <% else %>
                          <span class="text-danger"><%= stat[:accuracy_rate] %>%</span>
                        <% end %>
                      </td>
                      <td><%= stat[:average_response_time] %>秒</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted">この動画には問題がありません。</p>
          <% end %>
        </div>
      </div>

      <!-- 学習セッション統計 -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">総学習セッション</h5>
              <h2 class="text-primary"><%= @total_sessions %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">完了セッション</h5>
              <h2 class="text-success"><%= @completed_sessions %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">平均学習時間</h5>
              <h2 class="text-info">
                <% if @average_session_duration && @average_session_duration > 0 %>
                  <%= (@average_session_duration / 60).round(1) %>分
                <% else %>
                  -
                <% end %>
              </h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">平均最終スコア</h5>
              <h2 class="text-warning">
                <% if @average_final_score %>
                  <%= @average_final_score.round(1) %>点
                <% else %>
                  -
                <% end %>
              </h2>
            </div>
          </div>
        </div>
      </div>

      <!-- 学習セッション一覧 -->
      <div class="card mb-4">
        <div class="card-header">
          <h3>学習セッション履歴</h3>
        </div>
        <div class="card-body">
          <% if @learning_sessions.any? %>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>受講者</th>
                    <th>開始時刻</th>
                    <th>終了時刻</th>
                    <th>学習時間</th>
                    <th>最終スコア</th>
                    <th>イベント数</th>
                    <th>詳細</th>
                  </tr>
                </thead>
                <tbody>
                  <% @learning_sessions.each do |session| %>
                    <tr>
                      <td>
                        <%= session.user.name %>
                        <br><small class="text-muted"><%= session.user.email %></small>
                      </td>
                      <td><%= session.session_start_time.strftime("%Y/%m/%d %H:%M") %></td>
                      <td>
                        <% if session.session_end_time %>
                          <%= session.session_end_time.strftime("%Y/%m/%d %H:%M") %>
                        <% else %>
                          <span class="text-warning">進行中</span>
                        <% end %>
                      </td>
                      <td><%= session.format_duration %></td>
                      <td>
                        <% if session.final_score %>
                          <span class="badge <%= session.final_score >= 70 ? 'bg-success' : session.final_score >= 50 ? 'bg-warning' : 'bg-danger' %>">
                            <%= session.final_score.round(1) %>点
                          </span>
                        <% else %>
                          -
                        <% end %>
                      </td>
                      <td><%= session.total_events || session.timestamp_events.count %></td>
                      <td>
                        <button class="btn btn-sm btn-primary" onclick="showSessionDetail(<%= session.id %>)">
                          タイムライン表示
                        </button>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted">まだ学習セッションがありません。</p>
          <% end %>
        </div>
      </div>

      <!-- 詳細な回答履歴 -->
      <div class="card">
        <div class="card-header">
          <h3>回答履歴</h3>
        </div>
        <div class="card-body">
          <% if @user_responses.any? %>
            <div class="table-responsive">
              <table class="table table-striped table-sm">
                <thead>
                  <tr>
                    <th>受講者</th>
                    <th>問題</th>
                    <th>回答</th>
                    <th>正誤</th>
                    <th>回答時間</th>
                    <th>回答日時</th>
                  </tr>
                </thead>
                <tbody>
                  <% @user_responses.each do |response| %>
                    <tr>
                      <td>
                        <% if response.user %>
                          <%= response.user.name %>
                          <br><small class="text-muted"><%= response.user.email %></small>
                        <% else %>
                          <em>ゲストユーザー</em>
                        <% end %>
                      </td>
                      <td><%= truncate(response.question.content, length: 40) %></td>
                      <td><%= truncate(response.user_answer, length: 30) %></td>
                      <td>
                        <% if response.is_correct %>
                          <span class="badge bg-success">正解</span>
                        <% else %>
                          <span class="badge bg-danger">不正解</span>
                        <% end %>
                      </td>
                      <td>
                        <% if response.response_time %>
                          <%= (response.response_time / 1000.0).round(1) %>秒
                        <% else %>
                          -
                        <% end %>
                      </td>
                      <td><%= response.created_at.strftime("%Y/%m/%d %H:%M") %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted">まだ回答がありません。</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- セッション詳細モーダル -->
<div class="modal fade" id="sessionDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">学習セッション詳細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- グラフエリア -->
        <div id="chartContainer">
          <canvas id="timelineChart" width="800" height="400"></canvas>
        </div>
        
        <!-- タイムスタンプログ -->
        <div class="mt-4">
          <h6>タイムスタンプログ</h6>
          <div id="timestampLog" style="max-height: 300px; overflow-y: auto;">
            <!-- JavaScriptで動的に生成 -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .timestamp-entry {
    padding: 8px;
    margin-bottom: 4px;
    border-left: 3px solid #007bff;
    background-color: #f8f9fa;
    border-radius: 4px;
  }
  
  .timestamp-entry.score-event {
    border-left-color: #28a745;
  }
  
  .timestamp-entry.video-event {
    border-left-color: #ffc107;
  }
  
  .timestamp-entry.interaction-event {
    border-left-color: #17a2b8;
  }
  
  .timestamp-header {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    margin-bottom: 4px;
  }
  
  .timestamp-description {
    font-size: 0.9em;
    color: #6c757d;
  }
</style>

<script>
let currentChart = null;

function showSessionDetail(sessionId) {
  // モーダルを表示
  const modal = new bootstrap.Modal(document.getElementById('sessionDetailModal'));
  modal.show();
  
  // セッションデータを取得
  fetch(`<%= video_management_session_detail_path(video_id: @video, session_id: 'SESSION_ID') %>`.replace('SESSION_ID', sessionId), {
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    renderChart(data);
    renderTimestampLog(data);
  })
  .catch(error => {
    console.error('セッションデータ取得エラー:', error);
  });
}

function renderChart(data) {
  const ctx = document.getElementById('timelineChart').getContext('2d');
  
  // 既存のチャートを削除
  if (currentChart) {
    currentChart.destroy();
  }
  
  currentChart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [
        {
          label: '集中度スコア',
          data: data.timeline,
          borderColor: '#007bff',
          backgroundColor: 'rgba(0, 123, 255, 0.1)',
          tension: 0.4,
          parsing: {
            xAxisKey: 'x',
            yAxisKey: 'y'
          }
        },
        {
          label: 'スコア変化イベント',
          data: data.score_changes,
          borderColor: '#28a745',
          backgroundColor: '#28a745',
          pointRadius: 6,
          showLine: false,
          parsing: {
            xAxisKey: 'time',
            yAxisKey: 'score'
          }
        },
        {
          label: '動画操作',
          data: data.video_operations,
          borderColor: '#ffc107',
          backgroundColor: '#ffc107',
          pointRadius: 8,
          pointStyle: 'triangle',
          showLine: false,
          parsing: {
            xAxisKey: 'time',
            yAxisKey: function(ctx) {
              // 動画操作は固定の高さで表示
              return 50;
            }
          }
        },
        {
          label: 'ユーザー操作',
          data: data.interactions,
          borderColor: '#17a2b8',
          backgroundColor: '#17a2b8',
          pointRadius: 5,
          pointStyle: 'circle',
          showLine: false,
          parsing: {
            xAxisKey: 'time',
            yAxisKey: function(ctx) {
              // ユーザー操作は固定の高さで表示
              return 30;
            }
          }
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          type: 'linear',
          title: {
            display: true,
            text: '経過時間 (秒)'
          }
        },
        y: {
          title: {
            display: true,
            text: '集中度スコア'
          },
          min: 0,
          max: 100
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const point = context.parsed;
              const rawData = context.raw;
              
              if (context.datasetIndex === 0) {
                return `スコア: ${point.y.toFixed(1)}点 (${formatTime(point.x)})`;
              } else if (context.datasetIndex === 1) {
                return `${rawData.reason} (${rawData.change > 0 ? '+' : ''}${rawData.change.toFixed(1)}点)`;
              } else if (context.datasetIndex === 2) {
                return `${rawData.description} (動画時刻: ${formatTime(rawData.video_time)})`;
              } else {
                return rawData.description;
              }
            }
          }
        }
      }
    }
  });
}

function renderTimestampLog(data) {
  const logContainer = document.getElementById('timestampLog');
  
  // 全イベントを時系列順に結合
  const allEvents = [
    ...data.timeline.map(e => ({...e, category: 'timeline'})),
    ...data.score_changes.map(e => ({...e, category: 'score'})),
    ...data.video_operations.map(e => ({...e, category: 'video'})),
    ...data.interactions.map(e => ({...e, category: 'interaction'}))
  ].sort((a, b) => (a.time || a.x) - (b.time || b.x));
  
  logContainer.innerHTML = allEvents.map(event => {
    const time = event.time || event.x;
    const category = event.category;
    
    return `
      <div class="timestamp-entry ${category}-event">
        <div class="timestamp-header">
          <span>${formatTime(time)}</span>
          <span class="badge bg-secondary">${category}</span>
        </div>
        <div class="timestamp-description">
          ${event.description || event.reason || event.operation || event.type}
        </div>
      </div>
    `;
  }).join('');
}

function formatTime(seconds) {
  const minutes = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${minutes}:${secs.toString().padStart(2, '0')}`;
}
</script>
